<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Arch Linux on Laptop &#183; Fang Deng</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>(->> truth make (desire))</h1></a><span class=lead>May the sapphire star light your wayâœ¨</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Arch Linux on Laptop</h1><span class=post-date>Nov 8, 2022
&nbsp;&#183;&nbsp; 4 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><p>I recently got my new laptop and I found that some additional tweaks need to be made for laptops. Thus, this post is to have a record in case I forget when I have to reinstall the system.</p><h2 id=installing-arch-linux>Installing Arch Linux</h2><p>I have a script to handle this: <a href=https://github.com/peromage/pew/blob/master/rice/scripts/setup/arch-install.sh>https://github.com/peromage/pew/blob/master/rice/scripts/setup/arch-install.sh</a></p><h2 id=laptop-disk-partitioning-and-encryption>Laptop Disk Partitioning and Encryption</h2><p>Unlike desktop, laptops have to be secure so encrytion is a must.</p><p>Details of how-to can be found on Arch wiki. I&rsquo;m not going to go through that here. However, I&rsquo;ll note down some considerations and things that need to pay attention to.</p><h3 id=partitioning>Partitioning</h3><p><a href=https://wiki.archlinux.org/title/Btrfs>Arch wiki about BTRFS</a></p><p>Using too many partitions is not good for SSD so I only have two partitions on the disk: EFI partition (also as boot) + a big partition formated with <code>BTRFS</code>. The second partition is encrypted, which will be demonstrated in the next topic.</p><p>With <code>BTRFS</code>, I can use subvolume to achieve the similar effect like what partition does, but it is more flexible.</p><p>These subvolumes are created under the big <code>BTRFS</code>&rsquo;s root.</p><table><thead><tr><th>Subvolume</th><th>Mount Point</th><th>Note</th></tr></thead><tbody><tr><td>@arch-root</td><td>/</td><td>System root</td></tr><tr><td>@arch-var</td><td>/var</td><td>Avoid getting snapshot</td></tr><tr><td>@home</td><td>/home</td><td>Separated home</td></tr><tr><td>@swap</td><td>/.swap</td><td>Swap files (no compression, no CoW)</td></tr><tr><td>@snapshot</td><td>/.snapshot</td><td>Snapshots</td></tr></tbody></table><p>An example of how <code>fstab</code> is set up.</p><p>Be aware that swap subvolume should NOT be mounted with compression on.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/myroot LABEL=FFROOT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>dcc33411-f4ae-46e0-ba7a-f285301b25f6	/         	btrfs     	rw,noatime,compress=zstd:3,ssd,space_cache=v2,subvol=/@arch-root	0 1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/nvme0n1p1 LABEL=EFI</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1569-822D 					/boot     	vfat      	rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro	0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/myroot LABEL=FFROOT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>dcc33411-f4ae-46e0-ba7a-f285301b25f6	/home     	btrfs     	rw,noatime,compress=zstd:3,ssd,space_cache=v2,subvol=/@home	0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/myroot LABEL=FFROOT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>dcc33411-f4ae-46e0-ba7a-f285301b25f6	/var     	btrfs     	rw,noatime,compress=zstd:3,ssd,space_cache=v2,subvol=/@arch-var	0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/myroot LABEL=FFROOT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>dcc33411-f4ae-46e0-ba7a-f285301b25f6	/.swap 		btrfs     	rw,noatime,ssd,space_cache=v2,subvol=/@swap 			0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Swap files</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/.swap/swap-32gb.img 				none 		swap 		defaults 							0 0</span>
</span></span></code></pre></div><h3 id=encryption>Encryption</h3><p><a href=https://wiki.archlinux.org/title/dm-crypt/Encrypting_an_entire_system>Arch wiki about encryption</a></p><p>Use <code>LUKS2</code>. The latest <code>GRUB2</code> has integrated the support for this new algorithm. Why not using it?</p><p>As for the scheme, I leave EFI partition unencrypted and encrypt the whole <code>BTRFS</code> partition. EFI partition also acts as boot partition (ramfs and kernel reside).</p><p>The reason that I don&rsquo;t put boot partition encrypted is that I have to decrypt twice on startup: once by <code>GRUB</code> and the other one by kernel. Though there is a way to <a href=https://wiki.archlinux.org/title/dm-crypt/Encrypting_an_entire_system#Avoiding_having_to_enter_the_passphrase_twice>setup a key file</a> to avoid that, I still prefer typing password (Maybe TPM can be used).</p><p>To tell kernel to decrypt the disk on startup, ramfs and kernel parameters have to be updated.</p><p>Kernel parameters. The UUID has to be the UUID of the partition itself (not unencrypted BTRFS partition).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cryptdevice=UUID=51d2be03-b9a4-4d4d-bc5a-0a9dba854c1f:ffroot root=/dev/mapper/ffroot&#34;</span>
</span></span></code></pre></div><p>Update ramfs hooks. <code>encrypt</code> needs to go after <code>udev</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>HOOKS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(base udev autodetect modconf block filesystems keyboard fsck encrypt)</span>
</span></span></code></pre></div><h2 id=hibernation>Hibernation</h2><p>A workaround has to be made on <code>BTRFS</code> with swap files.</p><p>First swap files should <strong>NOT</strong> be set with CoW attribute.</p><p>Follow <a href=https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Hibernation_into_swap_file_on_Btrfs>this wiki</a> to calculate swap file physical offset on <code>BTRFS</code> partition.</p><p>Then set kernel parameters. The UUID should be the UUID of decrypted <code>BTRFS</code> partition. Differentiate from the UUID above.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;resume=UUID=dcc33411-f4ae-46e0-ba7a-f285301b25f6 resume_offset=3420784&#34;</span>
</span></span></code></pre></div><p>Update ramfs. Add <code>resume</code> hook.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>HOOKS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(base udev autodetect modconf block filesystems keyboard fsck encrypt resume)</span>
</span></span></code></pre></div><h2 id=tlp>TLP</h2><p>My <code>TLP</code> preferences.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/tlp.d/my-power-plan.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>TLP_DEFAULT_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>AC</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>TLP_PERSISTENT_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_SCALING_GOVERNOR_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>performance</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_SCALING_GOVERNOR_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>powersave</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_ENERGY_PERF_POLICY_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>balance_performance</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_ENERGY_PERF_POLICY_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>balance_power</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MIN_PERF_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MAX_PERF_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>100</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MIN_PERF_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MAX_PERF_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_BOOST_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_BOOST_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_HWP_DYN_BOOST_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_HWP_DYN_BOOST_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SCHED_POWERSAVE_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SCHED_POWERSAVE_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span></code></pre></div><h2 id=hidpi>HiDPI</h2><p>Update: I switched to KDE as the default desktop environment so HiDPI is not a problem anymore.</p><h3 id=xfce-obsolete>XFCE - Obsolete</h3><p><code>XFCE</code> is my choice of &ldquo;just works&rdquo; desktop environment. It has some issues with HiDPI out of the box so some tweaks need to be made.</p><p><a href=https://wiki.archlinux.org/title/HiDPI#Xfce>Arch wiki</a> has elaborated it already.</p><p>In short, update scaling:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>xfconf-query -c xfwm4 -p /general/theme -s Default-xhdpi
</span></span></code></pre></div><p>In <code>~/.xinitrc</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GDK_DPI_SCALE</span><span style=color:#ce5c00;font-weight:700>=</span>0.5
</span></span><span style=display:flex><span><span style=color:#204a87>exec</span> startxfce4
</span></span></code></pre></div><p>The only problem is 2x scaling sometimes is too big. GTK doesn&rsquo;t have the plan to support fractional scaling, which sucks. I might switch to a Qt-based desktop environment.</p><h2 id=firefox-scrolling-with-touchpad>Firefox scrolling with touchpad</h2><p>Yuck. Default scrolling experience on touchpad is just disgusting. To optimize it a bit, go to <code>about:config</code> page.</p><p>Change configurations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mousewheel.acceleration.start             1
</span></span><span style=display:flex><span>mousewheel.default.delta_multiplier_y     2
</span></span></code></pre></div><h2 id=framework-laptop-specific>Framework Laptop Specific</h2><p>Framework laptop needs some additional tweaks.</p><h3 id=ambient-light-sensor>Ambient Light Sensor</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S iio-sensor-proxy</span>
</span></span></code></pre></div><h3 id=fingerprint>Fingerprint</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S fprintd</span>
</span></span></code></pre></div><h3 id=bluetooth>Bluetooth</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S bluez bluez-utils</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemctl enable --now bluetooth</span>
</span></span></code></pre></div><h3 id=touchpad-two-finger-three-finger-click>Touchpad Two-finger/Three-finger Click</h3><ol><li>Get touchpad device id</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># xinput</span>
</span></span></code></pre></div><ol><li>Add to .xinitrc</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># xinput set-prop &lt;device&gt; &#39;libinput Click Method Enabled&#39; 0 1</span>
</span></span></code></pre></div><h3 id=brightness-keys>Brightness Keys</h3><p>Add to kernel parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;module_blacklist=hid_sensor_hub&#34;</span>
</span></span></code></pre></div><h3 id=suspend-power>Suspend Power</h3><p>Add to kernel parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;mem_sleep_default=deep nvme.noacpi=1&#34;</span>
</span></span></code></pre></div></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a></span>
<span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a></span>
<span class=icons-item><a href=mailto:fang@saffyyre.com><i class="fas fa-envelope fa-1x"></i></a></span>
<span class=icons-item><a href=/gpg-pubkey.txt><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2022 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>