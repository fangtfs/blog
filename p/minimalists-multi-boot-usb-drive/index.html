<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Story Recently I&amp;rsquo;ve realized a fact that I always have needs to keep a multi-boot USB in my pocket for either Linux or Windows installation. There are a lot tools out there already but I don&amp;rsquo;t really like them. At least, I mean, they are too flashy to me. A beautiful boot menu seems not to be attractive. What I need is just a simple and practical maybe a little ugly boot device."><title>Minimalist's Multi-boot USB Drive</title>
<link rel=canonical href=https://peromage.github.io/p/minimalists-multi-boot-usb-drive/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Minimalist's Multi-boot USB Drive">
<meta property="og:description" content="Story Recently I&amp;rsquo;ve realized a fact that I always have needs to keep a multi-boot USB in my pocket for either Linux or Windows installation. There are a lot tools out there already but I don&amp;rsquo;t really like them. At least, I mean, they are too flashy to me. A beautiful boot menu seems not to be attractive. What I need is just a simple and practical maybe a little ugly boot device.">
<meta property="og:url" content="https://peromage.github.io/p/minimalists-multi-boot-usb-drive/">
<meta property="og:site_name" content="Skag Den">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Multi-boot"><meta property="article:tag" content="USB"><meta property="article:published_time" content="2022-01-26T20:34:18+00:00"><meta property="article:modified_time" content="2022-01-26T20:34:18+00:00">
<meta name=twitter:title content="Minimalist's Multi-boot USB Drive">
<meta name=twitter:description content="Story Recently I&amp;rsquo;ve realized a fact that I always have needs to keep a multi-boot USB in my pocket for either Linux or Windows installation. There are a lot tools out there already but I don&amp;rsquo;t really like them. At least, I mean, they are too flashy to me. A beautiful boot menu seems not to be attractive. What I need is just a simple and practical maybe a little ugly boot device.">
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://peromage.github.io class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/tech/>
Tech
</a>
</header>
<h2 class=article-title>
<a href=/p/minimalists-multi-boot-usb-drive/>Minimalist's Multi-boot USB Drive</a>
</h2>
<footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--published>Jan 26, 2022</time>
</footer></div>
</header>
<section class=article-content>
<h1 id=story>Story</h1>
<p>Recently I&rsquo;ve realized a fact that I always have needs to keep a multi-boot USB in my pocket for either Linux or Windows installation. There are a lot tools out there already but I don&rsquo;t really like them. At least, I mean, they are too flashy to me. A beautiful boot menu seems not to be attractive. What I need is just a simple and practical maybe a little ugly boot device. It should be minimalist. More importantly, it has to be easy to setup with the tools on the system already and maintainable. No funky scripts.</p>
<h1 id=old-solution---clunky>Old Solution - Clunky</h1>
<p>I&rsquo;ve been using this solution for a very long time. Setup is pretty straight forward.</p>
<p>The partition scheme used on the USB drive is like (GPT):</p>
<pre><code>/dev/sda1    - 100 GB. NTFS. Data partition
/dev/sda2    - 512 MB. FAT. EFI partition
/dev/sda3    - 1 MB. No filesystem. BIOS boot partition used by GRUB
/dev/sda4    - 8 GB. NTFS. Windows ISO files
/dev/sda5    - 2 GB. FAT. Arch Linux ISO files
</code></pre><p>So the idea is having a big data partition at the front for better access, then installing GRUB files on the second EFI partition with both EFI and BIOS support (Implemented by the third BIOS boot partition. The partition order doesn&rsquo;t matter). Finally, create dedicated partitions to contain the extracted files from installation ISOs.</p>
<p>When the USB drive is plugged in, I can use grub command line to chainload the EFI file that is located in the ISO partition, or the VBR if it&rsquo;s booted with legacy mode.</p>
<p>Well, it&rsquo;s usable but I still feel that it is too much for a small USB drive - too many partitions. If I plug the drive in for just data exchange, there would be a a bunch of partitions mounted and the notification is quite annoying. So I started thinking that there must be a simpler way to do it.</p>
<h1 id=new-solution---much-better>New Solution - Much Better</h1>
<h2 id=partitioning>Partitioning</h2>
<p>The goal is simplicity so the new partition scheme is like this:</p>
<pre><code>/dev/sda1    - 100 GB. NTFS. Data partition
/dev/sda2    - 512 MB. FAT. EFI partition
/dev/sda3    - 1 MB. No filesystem. BIOS boot partition used by GRUB (Optional)
</code></pre><p>The third BIOS boot partition is not really necessary since most of computers nowadays are using UEFI. If you really need the legacy compatibility, you can create one. I&rsquo;ll keep it for now.</p>
<h2 id=installing-grub>Installing GRUB</h2>
<p>Typical GRUB insallation but install for both EFI and BIOS.</p>
<pre><code class=language-console data-lang=console># mount /dev/sda2 /mnt
# grub-install --target=x86_64-efi --efi-directory=/mnt --boot-directory=/mnt --removable
# grub-install --target=i386-pc --boot-directory=/mnt /dev/sda
</code></pre><p>Don&rsquo;t forget to create a GRUB menu config file. Otherwise GRUB will boot into its command line interface (If you know what you&rsquo;re doing). It&rsquo;s a good idea to put a editable config file in the data partition since it will be the most used partition. However, GRUB reads the file in the EFI partition by default: <code>(esp)/grub/grub.cfg</code>. We can tell GRUB to read out custom config file after that.</p>
<pre><code class=language-grub data-lang=grub># (esp)/grub/grub.cfg

search --set=root --file /boot.cfg
configfile /boot.cfg
</code></pre><p>Thus we are done with the EFI partition. All the menu configuration will go into <code>boot.cfg</code> in the data partition.</p>
<h2 id=linux-installer>Linux Installer</h2>
<p>Most of modern Linux distros support booting from a loop device. That is to say, we don&rsquo;t have to extract the content of ISO files. Using GRUB <code>loopback</code> command can easily mount a ISO and boot from there. But chainloading the EFI or VBF is not possible. Based on the <a class=link href=https://www.gnu.org/software/grub/manual/grub/grub.html#Loopback-booting target=_blank rel=noopener>GRUB manual</a>:</p>
<blockquote>
<p>GRUB is able to read from an image (be it one of CD or HDD) stored on any of its accessible storages (refer to see loopback command). However the OS itself should be able to find its root. This usually involves running a userspace program running before the real root is discovered.</p>
</blockquote>
<p>EFI bootloader usually will fail to find the root device by this method. However, we can manually load the kernel and ramdisk in which we can specify the root device by ourselves.</p>
<h3 id=load-linux-iso>Load Linux ISO</h3>
<p>I&rsquo;m using Arch Linux here for example.</p>
<ol>
<li>Put the ISO file to <code>(data)/images/archlinux-2022.01.01-x86_64.iso</code>.</li>
<li>Mount ISO. We need to find the kernel loading parameters.</li>
<li>In the file <code>(arch)/syslinux/archiso_sys-linux.cfg</code> we would see</li>
</ol>
<pre><code class=language-config data-lang=config># Copy to RAM boot option
LABEL arch64ram
TEXT HELP
Boot the Arch Linux install medium on BIOS with Copy-to-RAM option
It allows you to install Arch Linux or perform system maintenance.
ENDTEXT
MENU LABEL Arch Linux install medium (x86_64, BIOS, Copy to RAM)
LINUX /arch/boot/x86_64/vmlinuz-linux
INITRD /arch/boot/intel-ucode.img,/arch/boot/amd-ucode.img,/arch/boot/x86_64/initramfs-linux.img
APPEND archisobasedir=arch archisolabel=ARCH_202201 copytoram
</code></pre><p>This is a <code>syslinux</code> config file. Parameters after <code>APPEND</code> are the ones that we&rsquo;re looking for.</p>
<p>Then add the following content to <code>(data)/boot.cfg</code>. When copying the <code>initrd</code> parameters, don&rsquo;t forget to remove commas.</p>
<pre><code class=language-config data-lang=config>menuentry &quot;Archiso 202201 RAM&quot; {
    search --set=root --file /boot.cfg
    loopback loop /images/archlinux-2022.01.01-x86_64.iso
    set root=(loop)
    linux /arch/boot/x86_64/vmlinuz-linux archisobasedir=arch archisolabel=ARCH_202201 copytoram
    initrd /arch/boot/intel-ucode.img /arch/boot/amd-ucode.img /arch/boot/x86_64/initramfs-linux.img
}
</code></pre><p>Then the Linux installer is done. If we need more distros, the process is similar.</p>
<h2 id=windows-installer>Windows Installer</h2>
<p>I prefer to use NTFS as my data partition&rsquo;s file system because it works on both Linux and Windows, and supports big files. Also I usually just keep one copy of Windows installer so for Windows, I can simply dump the ISO content to the data partition&rsquo;s root. I don&rsquo;t mind the extra a few folders there. Plus some of them can be safely deleted. Then chainloading from GRUB is possible.</p>
<p>In <code>(data)/boot.cfg</code></p>
<pre><code class=language-config data-lang=config>menuentry &quot;Windows 10 Installer&quot; {
    search --set=root --file /boot.cfg
    chainloader /efi/boot/bootx64.efi
}
</code></pre><h2 id=windows-pe>Windows PE</h2>
<p>Alternatively, I can directly boot from a small WinPE image and use <code>dism</code> command to extract <code>install.wim</code> to the target without accepting the annoying Windows partition scheme (You know what I&rsquo;m talking about).</p>
<p>To create a PE image we need a Windows environment and a CMD window with admin privilege.</p>
<p>Create a virtual disk to contain PE files. Assigned with volume letter <code>P:\</code>.</p>
<pre><code class=language-console data-lang=console>&gt; diskpart
DISKPART&gt; create vdisk file=c:\winpe.vhd maximum=2000 type=fixed
DISKPART&gt; select vdisk file=c:\winpe.vhd
DISKPART&gt; attach vdisk
DISKPART&gt; convert mbr
DISKPART&gt; create partition primary
DISKPART&gt; format fs=ntfs quick
DISKPART&gt; assign letter=p
DISKPART&gt; exit
</code></pre><p>Then mount the Windows installer ISO. Assuming the assigned volume is <code>G:\</code>.</p>
<pre><code class=language-console data-lang=console>dism /apply-image /imagefile:g:\sources\boot.wim /index:1 /applydir:p:\
dism /image:p:\ /set-targetpath:x:\
dism /image:p:\ /set-inputlocale:en-us
dism /image:p:\ /set-userlocale:en-us
</code></pre><p>Assign EFI partition with volume letter <code>E:\</code>.</p>
<p>Before creating the bootloader for Windows PE, we need to backup our GRUB EFI file (Windows PE bootloader will overwrite it). Rename <code>E:\EFI</code> to <code>E:\EFI-grub</code>.</p>
<p>Create Windows PE bootloader.</p>
<pre><code class=language-console data-lang=console>&gt; bcdboot p:\Windows /l en-us /s e: /f uefi
</code></pre><p>Then merge both <code>E:\EFI</code> and <code>E:\EFI-grub</code>. If it prompts overwriting <code>E:\EFI\Boot\bootx64.efi</code>, confirm with yes.</p>
<p>Then add following content to <code>(data)/boot.cfg</code>.</p>
<pre><code class=language-config data-lang=config>menuentry &quot;Windows PE&quot; {
    search --set=root --file /boot.cfg
    chainloader /EFI/Microsoft/Boot/bootmgfw.efi
}
</code></pre><h2 id=loading-any-iso>Loading Any ISO</h2>
<p>Some ISO is capable to be loaded directly into memory. The size of the ISO file is critical. Generally it should not exceed the physical memory. This can be done by <code>memdisk</code> from <code>syslinux</code>.</p>
<p>Copy the <code>memdisk</code> into the EFI partition.</p>
<pre><code class=language-console data-lang=console># cp /usr/lib/syslinux/bios/memdisk (esp)/memdisk
</code></pre><p>Then put the following content to <code>(data)/boot.cfg</code>. For example, loading a Windows PE ISO.</p>
<pre><code class=language-config data-lang=config>menuentry &quot;Windows PE ISO&quot; {
    search --set=root --file /boot.cfg
    linux16 memdisk iso ro
    initrd16 /images/winpe.iso
}
</code></pre><h1 id=the-end>The End</h1>
<p>Finally I&rsquo;m very satisfied with this new USB drive. Yay!</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/multi-boot/>Multi-boot</a>
<a href=/tags/usb/>USB</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/p/dual-booting-windows-vhd-and-native-linux-on-a-bios-gpt-pc/>
<div class=article-details>
<h2 class=article-title>Dual-booting Windows VHD and Native Linux on a BIOS+GPT PC</h2>
</div>
</a>
</article>
<article>
<a href=/p/windows-linux-%E5%8F%8C%E7%B3%BB%E7%BB%9F%E5%BC%95%E5%AF%BC%E6%89%8B%E8%AE%B0/>
<div class=article-details>
<h2 class=article-title>Windows + Linux 双系统引导手记</h2>
</div>
</a>
</article>
<article>
<a href=/p/fix-metadata-of-google-photo-takeout/>
<div class=article-details>
<h2 class=article-title>Fix Metadata of Google Photo Takeout</h2>
</div>
</a>
</article>
<article>
<a href=/p/shadowsocks-quick-setup/>
<div class=article-details>
<h2 class=article-title>Shadowsocks Quick Setup</h2>
</div>
</a>
</article>
<article>
<a href=/p/ssh-over-gpg-agent/>
<div class=article-details>
<h2 class=article-title>SSH Over GPG Agent</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 Skag Den
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#partitioning>Partitioning</a></li>
<li><a href=#installing-grub>Installing GRUB</a></li>
<li><a href=#linux-installer>Linux Installer</a>
<ol>
<li><a href=#load-linux-iso>Load Linux ISO</a></li>
</ol>
</li>
<li><a href=#windows-installer>Windows Installer</a></li>
<li><a href=#windows-pe>Windows PE</a></li>
<li><a href=#loading-any-iso>Loading Any ISO</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>