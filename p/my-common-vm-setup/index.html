<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>My Common VM Setup &#183; Fang Deng</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>(->> truth seek (desire))</h1></a><span class=lead>May the sapphire star light your wayâœ¨</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>My Common VM Setup</h1><span class=post-date>Mar 13, 2022
&nbsp;&#183;&nbsp; 8 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><h2 id=before-starting>Before Starting</h2><p>This post mainly discusses VM setup for Windows since I&rsquo;ve been using Windows as a secondary OS for apps or games that cannot run on Linux.</p><p>This post discusses setup on Arch Linux.</p><p>This post assumes the CPU and motherboard support <code>VT-d</code> and <code>IOMMU</code> features. Detailed prerequisites can be found on <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>this page</a>.</p><h2 id=install-hypervisor>Install Hypervisor</h2><p>Follow Arch wiki to install and setup:</p><ol><li><a href=https://wiki.archlinux.org/title/QEMU>QEMU</a></li><li><a href=https://wiki.archlinux.org/title/libvirt>Libvirt</a></li><li><a href=https://wiki.archlinux.org/title/Virt-Manager>Virt-Manager</a></li><li><a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>OVMF</a></li></ol><h2 id=install-windows-vm>Install Windows VM</h2><h3 id=before-installation>Before Installation</h3><p>Download the latest Windows 10 ISO from <a href=https://www.microsoft.com/en-ca/software-download/windows10ISO>Microsoft</a>. Windows 11 is buggy and requires Microsoft account login during installation, which sucks.</p><p>We also need to get <a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>VirtIO</a> driver before installing Windows.</p><h3 id=during-installation>During Installation</h3><p>Then create a new VM with the following configuration before starting installation:</p><ul><li>Overview: Change <em>Firmware</em> to <code>UEFI</code>.</li><li>CPUs:<ul><li>Unselect <em>Copy host CPU configuration</em> and change <em>Model</em> to <code>host-passthrough</code>.</li><li>Select <em>Manually set CPU topology</em>. Change <em>Sockets</em> to <code>1</code>, <em>Cores</em> to <code>4</code>, <em>Threads</em> to <code>2</code> (Physical core <code>4</code> * threads for each core <code>2</code>).</li></ul></li><li>Disk: Change <em>Disk bus</em> to <code>VirtIO</code>.</li><li>Display Spice: Use <em>Type</em> <code>Spice server</code>.</li><li>Video: Use <em>Model</em> <code>QXL</code>.</li></ul><p>During the installation, the Windows installer may not be able to find the disk because it doesn&rsquo;t have the driver (that&rsquo;s why you have to download it beforehand). Load the driver from the ISO and continue installation. This step should be trivial.</p><h3 id=after-installation>After Installation</h3><p>Keep the <code>VirtIO</code> ISO in the CD ROM device when boot into Windows. Find <code>virtio-win-gt-x64.msi</code> and <code>virtio-win-guest-tools.exe</code> then install them both. Then power off VM.</p><p>Then configure VM:</p><ul><li>Add Hardware -> Channel -> Select <code>org.qemu.guest_agent.0</code> -> Finish</li></ul><p>Until here, the basic Windows VM setup is done.</p><h3 id=note>Note</h3><p>The video device doesn&rsquo;t support <code>VirtIO</code> <a href=https://wiki.archlinux.org/title/QEMU#virtio>on Windows</a> so we have to use <code>QXL</code> for now.</p><h2 id=passthrough-discrete-graphic-card>Passthrough: Discrete Graphic Card</h2><h3 id=identify-discrete-graphic-card>Identify Discrete Graphic Card</h3><p>In a terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci -nnk
</span></span><span style=display:flex><span>01:00.0 VGA compatible controller <span style=color:#ce5c00;font-weight:700>[</span>0300<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX 970<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>10de:13c2<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: nouveau
</span></span><span style=display:flex><span>    Kernel modules: nouveau
</span></span><span style=display:flex><span>01:00.1 Audio device <span style=color:#ce5c00;font-weight:700>[</span>0403<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>[</span>10de:0fbb<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: snd_hda_intel
</span></span><span style=display:flex><span>    Kernel modules: snd_hda_intel
</span></span></code></pre></div><p>Take a note of the device IDs. In this example I have a Nvidia GTX970 graphic card along with a audio controller. They belong to the same group (domain) you have to take them all.</p><p>In this case I got <code>10de:13c2</code> and <code>10de:0fbb</code>. These are the PCI devices that will be passed through to the VM. Other PCI devices can be passed too.</p><h3 id=add-kernel-parameters>Add Kernel Parameters</h3><p>Then we&rsquo;re going to enable IOMMU and prevent host Linux loading PCI devices that we want to passthrough to the VM.</p><p>The kernel parameter passing could be different depending on the bootloader you use. In this example, I use <code>systemd-boot</code>.</p><p>Edit the system entry. Add <code>intel_iommu=on</code> to the kernel parameter along with <code>vfio-pci.ids=10de:13c2,10de:0fbb</code> which contains the device IDs we got from the previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options intel_iommu</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>on vfio-pci.ids=10de:13c2,10de:0fbb</span>
</span></span></code></pre></div><p>Then restart the system.</p><p>NOTE: You can check <code>dmesg</code> after reboot to verify IOMMU is turned on successfully.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo dmesg <span style=color:#000;font-weight:700>|</span> grep -i -e DMAR -e IOMMU
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> ACPI: DMAR 0x00000000BDCB1CB0 0000B8 <span style=color:#ce5c00;font-weight:700>(</span>v01 INTEL  BDW      <span style=color:#0000cf;font-weight:700>00000001</span> INTL 00000001<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> Intel-IOMMU: enabled
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028879<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028883<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008c20660462 ecap f010da
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028950<span style=color:#ce5c00;font-weight:700>]</span> IOAPIC id <span style=color:#0000cf;font-weight:700>8</span> under DRHD base  0xfed91000 IOMMU <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536212<span style=color:#ce5c00;font-weight:700>]</span> DMAR: No ATSR found
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536229<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>0</span> 0xfed90000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536230<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>1</span> 0xfed91000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536231<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting RMRR:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536241<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:02.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbf000000 - 0xcf1fffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537490<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:14.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537512<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1a.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537530<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1d.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537543<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Prepare 0-16MiB unity mapping <span style=color:#204a87;font-weight:700>for</span> LPC
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537549<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1f.0 <span style=color:#ce5c00;font-weight:700>[</span>0x0 - 0xffffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    2.182790<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>drm<span style=color:#ce5c00;font-weight:700>]</span> DMAR active, disabling use of stolen memory
</span></span></code></pre></div><h3 id=passthrough-pci>Passthrough PCI</h3><p>Open VM settings and add the discrete graphic card as well as it&rsquo;s audio controller etc.</p><p>Then open VM settings in XML view, add following content in the relevant sections to prevent Nvidia driver installer discovering the VM environment. Some sections may exist already so just append to them.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;features&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;vendor_id</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#39;1234567890ab&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;kvm&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;hidden</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/kvm&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/features&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><p>Alternatively, this has the same effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># NOTE: win10 is the VM name you&#39;ve just created.</span>
</span></span><span style=display:flex><span>$ sudo virshpatcher --error43 --vender-id 1234567890ab win10
</span></span></code></pre></div><h3 id=install-drivers>Install Drivers</h3><p>Boot into Windows VM, now you should be able to install the graphic card driver.</p><h3 id=notes>Notes</h3><p>My setup is based on external GPU. If eGPU is powered on when laptop starts, somehow the kernel will be stuck. The eGPU has to be powered off and then powered on when system is up. Weird.</p><h2 id=passthrough-integrated-graphic-card-with-sr-iov>Passthrough: Integrated Graphic Card with SR-IOV</h2><p>I have a fairly new laptop with 12th gen Intel and Iris Xe graphic card but no discrete one. In this case Intel has provided a technology call <code>SR-IOV</code> which allows me to passthrough a part of my iGPU to the VM.</p><p>Note: <code>GVT-g</code> is <a href=https://wiki.archlinux.org/title/Intel_GVT-g#Prerequisite>only supported on 5th gen to 10th gen Intel CPUs</a>.</p><h3 id=install-kernel-module>Install Kernel Module</h3><p>I was following this <a href=https://github.com/intel/linux-intel-lts/issues/33>GitHub issue</a>. Basically an Intel customized <code>i915</code> kernel module is needed. However, thanks to @strongtz who has created an <a href=https://aur.archlinux.org/packages/i915-sriov-dkms-git>AUR package</a> so the Intel custom kernel is not required. All we need is this AUR package, which is awesome.</p><p>After installing the AUR package, update kernel parameters to enable IOMMU and SR-IOV virtual functions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span>options <span style=color:#000>intel_iommu</span><span style=color:#ce5c00;font-weight:700>=</span>on <span style=color:#000>iommu</span><span style=color:#ce5c00;font-weight:700>=</span>pt i915.enable_guc<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>7</span>
</span></span></code></pre></div><p>Then reboot the system.</p><h3 id=create-virtual-functions>Create Virtual Functions</h3><p>If hardware supports and configuration is correct, the following <a href=https://github.com/intel/linux-intel-lts/issues/33#issuecomment-1328970093>kernel message</a> should be observed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo dmesg <span style=color:#000;font-weight:700>|</span> grep i915_virtualization_probe
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    1.740640<span style=color:#ce5c00;font-weight:700>]</span> i915 0000:00:02.0: i915_virtualization_probe: entry
</span></span></code></pre></div><p>Then identify the iGPU by <code>lspci</code>. Usually Intel device starts with <code>00:02.x</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci <span style=color:#000;font-weight:700>|</span> grep -P <span style=color:#4e9a06>&#34;VGA.*Intel&#34;</span>
</span></span><span style=display:flex><span>00:02.0 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Then we should be able to get the number of virtual functions allowed currently.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>To enable virtual functions, run this command as root user. I&rsquo;m creating one virtual function since I only have one VM that needs it. Maximal 7 virtual functions can be created.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ su
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 1 &gt; /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs</span>
</span></span></code></pre></div><p>Finally check VGA device again, there should be an additional device created (the one starts with <code>00:02.1</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci <span style=color:#000;font-weight:700>|</span> grep -P <span style=color:#4e9a06>&#34;VGA.*Intel&#34;</span>
</span></span><span style=display:flex><span>00:02.0 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>00:02.1 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=install-intel-graphics-driver>Install Intel Graphics Driver</h3><p>Add the virtual PCI graphics adapter to VM (choose the shared on <code>00:02.1</code>) and boot up Windows. Be aware that we still the <code>QXL</code> video adapter this time.</p><p>Windows should now recognize a <strong>Display adapters/Microsoft Basic Display Adapter</strong> in <em>Device Manager</em> if everything is correct. Go to Intel website to get <a href=https://www.intel.ca/content/www/ca/en/download-center/home.html>the latest driver</a>.</p><p>Install it and reboot Windows. That adapter should now be recognized as <strong>Intel(R) Iris(R) Xe Graphics</strong>.</p><h3 id=install-looking-glass>Install Looking Glass</h3><p>Since I&rsquo;m setting this up on a laptop I don&rsquo;t have external display so <code>Looking Glass</code> must be used to redirect the VM display on the laptop screen.</p><h4 id=create-shared-memory>Create Shared Memory</h4><p>When the Windows VM is powered off, add the following content to the VM XML config (be aware of the hierarchy).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;device&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;shmem</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#39;looking-glass&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;model</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#39;ivshmem-plain&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;size</span> <span style=color:#c4a000>unit=</span><span style=color:#4e9a06>&#39;M&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>64<span style=color:#204a87;font-weight:700>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/device&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><p>The size of shared memory depends on the <a href=https://looking-glass.io/docs/B5.0.1/install/#determining-memory>maximal resolution</a> that Windows VM will be using. Simply this formula can be used. The result must be rounded up to the nearest power of 2.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>total bytes = width x height x 4 x 2 / 1024 / 1024 + 10
</span></span></code></pre></div><p>For example my Windows VM can setup maximal 2560x1600 so it would be <em>2560 x 1600 x 4 x 2 / 1024 / 1024 + 10 = 41.25</em>. Then round it up to <strong>64</strong>.</p><p>After that, create a temp file config. The user name must match the user that is being used.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/tmpfiles.d/10-looking-glass.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#Type Path                   Mode UID  GID Age Argument</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>f     /dev/shm/looking-glass 0660 user kvm -</span>
</span></span></code></pre></div><p>Create the temp file for the first time (it will be created automatically after reboot).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf
</span></span></code></pre></div><h4 id=install-host-service>Install Host Service</h4><p>Download and install Looking Glass <a href=https://looking-glass.io/downloads>service installer</a> in Windows. Note that Windows is the host in Looking Glass&rsquo;s context (Linux is the client that reads output from Windows VM).</p><p>Additionally, <code>IVSHMEM</code> <a href=https://looking-glass.io/docs/B5.0.1/install/#installing-the-ivshmem-driver>driver</a> is also needed so that Looking Glass service can shared the display via shared memory. It can be downloaded from <a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/>RedHat</a>.</p><p>Then go to <em>Device Manager</em> and find <strong>System Devices/PCI standard RAM Controller</strong>. Update its driver with the downloaded <code>IVSHMEM</code> driver.</p><h4 id=solve-display-adapter-error-code-43>Solve Display Adapter Error Code 43</h4><p>Similarly I got the same error code as the passthrough for discrete graphic card. To solve it, add the following content to the VM config XML.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;features&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;vendor_id</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#39;1234567890ab&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;kvm&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;hidden</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/kvm&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/features&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><h4 id=create-a-dummy-display>Create a Dummy Display</h4><p>Since Looking Glass basically mirrors display output, the VM must have a valid display (I.E. a monitor). We can use a dummy display to bypass it.</p><p>Download the <a href=https://github.com/ge9/IddSampleDriver>IddSampleDriver</a> from it&rsquo;s release page.</p><ul><li>Extract all content to <code>C:\IddSampleDriver</code> (Important since the path of config file is hard-coded).</li><li>Run <code>C:\installCert.bat</code> with Administrator privilege.</li><li>Install display driver: <em>Device Manager</em> -> <em>Add legacy haradware</em> -> <em>Advanced install</em> -> <em>Display adapter</em> -> <em>Browse driver on the disk</em> -> <em>Choose the inf file in the extracted directory</em>.</li><li>Restart Windows.</li></ul><h4 id=finish-up>Finish up</h4><p>Now get the same version of <a href=https://looking-glass.io/downloads>Looking Glass client</a> (important). Compile and run. The VM should be running smoothly with graphic acceleration.</p><h2 id=references>References</h2><p><a href=https://wiki.archlinux.org/title/QEMU>ArchWiki QEMU</a>
<a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>ArchWiki OVMF</a>
<a href=https://wiki.archlinux.org/title/Intel_GVT-g>Intel GVT-g</a>
<a href=https://looking-glass.io/>Looking Glass</a>
<a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>Virtio driver</a>
<a href=https://github.com/intel/linux-intel-lts/issues/33>SR-IOV: mainlining?</a>
<a href=https://github.com/strongtz/i915-sriov-dkms>strongtz/i915-sriov-dkms</a>
<a href=https://github.com/ge9/IddSampleDriver>ge9/IddSampleDriver</a>
<a href=https://www.reddit.com/r/VFIO/comments/wj6zhz/gpu_passthrough_looking_glass_no_external/>GPU Passthrough + Looking Glass + no external monitor/dummy</a></p></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a></span>
<span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a></span>
<span class=icons-item><a href=mailto:fang@saffyyre.com><i class="fas fa-envelope fa-1x"></i></a></span>
<span class=icons-item><a href=/gpg-pubkey.txt><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2022 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>