<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Setup A Gaming VM &#183; Fang Deng</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>(->> truth make (desire))</h1></a><span class=lead>May the sapphire star light your wayâœ¨</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Setup A Gaming VM</h1><span class=post-date>Mar 13, 2022
&nbsp;&#183;&nbsp; 5 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><h2 id=before-starting>Before starting</h2><p>First thing first. I&rsquo;ve been rarely using Windows over years except for working and gaming. Linux community grows fast and there are a lot alternatives available. On the contrary, Windows gets crapy every year (Office 365 is still good IMO) so there is no reason to run this huge spyware all the time.</p><p>Modern PCs are strong enough to run a VM. Besides most of PCs have both integrated and descret graphic cards. This setup is perfect for gaming VM which requires PCI passthrough.</p><p>In this post, I&rsquo;m not going to explain everything because the ArchWiki is clear enough already. This is just a quick guide for the setup.</p><p>NOTE: Avoid Intel K series CPUs which usually don&rsquo;t have integrated graphic card.</p><h2 id=get-started>Get started</h2><h3 id=identify-your-pc-is-qualified>Identify your PC is qualified</h3><p>To get high graphic performance, your CPU and motherboard must support <code>VT-d</code> and <code>IOMMU</code> respectively.</p><p>If not, you can stop here and choose the traditional way to dual-boot Linux and Windows.</p><p>NOTE: you can check <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>PCI passthrough via OVMF</a> prerequisite section for more information.</p><h3 id=install-qemu>Install QEMU</h3><p>I wrote a script to handle this automatically so just run <a href=https://github.com/peromage/rice/blob/master/scripts/install-qemu.sh>this script</a> before hands.</p><p>NOTE: I&rsquo;m using Arch Linux.</p><h3 id=identify-discrete-graphic-card>Identify discrete graphic card</h3><p>In a terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci -nnk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>01:00.0 VGA compatible controller <span style=color:#ce5c00;font-weight:700>[</span>0300<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX 970<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>10de:13c2<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: nouveau
</span></span><span style=display:flex><span>    Kernel modules: nouveau
</span></span><span style=display:flex><span>01:00.1 Audio device <span style=color:#ce5c00;font-weight:700>[</span>0403<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>[</span>10de:0fbb<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: snd_hda_intel
</span></span><span style=display:flex><span>    Kernel modules: snd_hda_intel
</span></span></code></pre></div><p>Take a note of the device IDs. In this example I have a Nvidia GTX970 graphic card along with a audio controller. They belong to the same group (domain) you have to take them all.</p><p>In this case I got <code>1458:367a</code> and <code>1458:367a</code>. These are the PCI devices that will be passed through to the VM. Other PCI devices can be passed too.</p><h3 id=modify-kernel-parameter>Modify kernel parameter</h3><p>Then we&rsquo;re going to turn IOMMU on and prevent host Linux loading PCI devices that we want to pass-through to the VM.</p><p>The kernel parameter passing could be different depending on the bootloader you use. In this example, I use <code>grub</code>.</p><p>Open <code>/etc/default/grub</code> with your favorite text editor. You have to add <code>intel_iommu=on</code> to the kernel parameter along with <code>vfio-pci.ids=10de:13c2,10de:0fbb</code> which contains the device IDs you got from the previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/default/grub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Change this line</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;loglevel=3 quiet&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># To</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>GRUB_CMDLINE_LINUX_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;loglevel=3 quiet intel_iommu=on vfio-pci.ids=10de:13c2,10de:0fbb&#34;</span>
</span></span></code></pre></div><p>Then update the bootloader config file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>The most tricky part is done. Restart the PC now.</p><p>NOTE: You can check <code>dmesg</code> after reboot to verify IOMMU is turned on successfully.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo dmesg <span style=color:#000;font-weight:700>|</span> grep -i -e DMAR -e IOMMU
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> ACPI: DMAR 0x00000000BDCB1CB0 0000B8 <span style=color:#ce5c00;font-weight:700>(</span>v01 INTEL  BDW      <span style=color:#0000cf;font-weight:700>00000001</span> INTL 00000001<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> Intel-IOMMU: enabled
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028879<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028883<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008c20660462 ecap f010da
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028950<span style=color:#ce5c00;font-weight:700>]</span> IOAPIC id <span style=color:#0000cf;font-weight:700>8</span> under DRHD base  0xfed91000 IOMMU <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536212<span style=color:#ce5c00;font-weight:700>]</span> DMAR: No ATSR found
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536229<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>0</span> 0xfed90000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536230<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>1</span> 0xfed91000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536231<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting RMRR:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536241<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:02.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbf000000 - 0xcf1fffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537490<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:14.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537512<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1a.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537530<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1d.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537543<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Prepare 0-16MiB unity mapping <span style=color:#204a87;font-weight:700>for</span> LPC
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537549<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1f.0 <span style=color:#ce5c00;font-weight:700>[</span>0x0 - 0xffffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    2.182790<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>drm<span style=color:#ce5c00;font-weight:700>]</span> DMAR active, disabling use of stolen memory
</span></span></code></pre></div><h3 id=install-the-vm>Install the VM</h3><p>Open virt-manager GUI and follow the guide to setup.</p><p>Some settings should be tweaked specifically:</p><ul><li>Overview: Change <em>Firmware</em> to <code>UEFI</code></li><li>CPUs:<ul><li>Change <em>vCPU allocation</em> to the maximal host CPUs. In this case, it&rsquo;s <code>8</code></li><li>Unselect <em>Copy host CPU configuration</em> and change <em>Model</em> to <code>host-passthrough</code></li><li>Select <em>Manually set CPU topology</em>. Change <em>Sockets</em> to <code>1</code>, <em>Cores</em> to <code>4</code>, <em>Threads</em> to <code>2</code> (Physical core <code>4</code> * threads for each core <code>2</code>)</li></ul></li><li>Disk: Change <em>Disk bus</em> to <code>VirtIO</code></li><li>Display Spice: You don&rsquo;t really need it so remove it</li><li>Video: Change to None</li><li>PCI: Add your discrete graphic card as well as anything with it (audio controller etc.)</li><li>USB: Mouse, keyboards, game controllers etc.</li></ul><p>After saving the settins, the installation should start but don&rsquo;t install Windows yet. Instead, force power if off. Open VM settings in XML view, add following content to prevent Nvidia driver installer discovering the VM environment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;features&gt;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;vendor_id</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#39;1234567890ab&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;kvm&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;hidden</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/kvm&gt;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/features&gt;</span>
</span></span></code></pre></div><p>Alternatively, this has the same effect.</p><p>NOTE: <code>win11</code> is the VM name you&rsquo;ve just created.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo virshpatcher --error43 --vender-id 1234567890ab win11
</span></span></code></pre></div><h3 id=install-virtio-drivers>Install virtio drivers</h3><p>In the Windows VM, download the <a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>virtio driver</a> and install it.</p><p>NOTE: Check <a href=https://wiki.archlinux.org/title/QEMU>ArchWiki QEMU</a> for more info</p><h2 id=post-installation>Post installation</h2><p>If you don&rsquo;t want to switch monitors you can try <a href=https://looking-glass.io/>Looking Glass</a> which allows you redirect VM display output to a emulated monitor.</p><h2 id=reference>Reference</h2><p>[<a href=https://github.com/peromage/rice/blob/master/scripts/install-qemu.sh>QEMU install script</a>
<a href=https://wiki.archlinux.org/title/QEMU>ArchWiki QEMU</a>
<a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>ArchWiki OVMF</a>
<a href=https://looking-glass.io/>Looking Glass</a>
<a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>Virtio driver</a></p></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a></span>
<span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a></span>
<span class=icons-item><a href=mailto:fang@saffyyre.com><i class="fas fa-envelope fa-1x"></i></a></span>
<span class=icons-item><a href=/gpg-pubkey.txt><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2022 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>